name: P-CSCF Full Pipeline (Podman/Buildah) - Alternative

# Alternative pipeline using Podman/Buildah instead of Docker
# This is a backup option if Docker continues to have issues
# To use: Rename this file to pcscf-full-pipeline.yml

on:
  workflow_dispatch:
    inputs:
      use_podman:
        description: 'Use Podman instead of Docker'
        required: false
        default: 'true'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/pcscf
  COMPONENT: pcscf

jobs:
  build:
    name: Build Container (Podman)
    runs-on: self-hosted
    # Note: No 'dind' label needed - Podman doesn't need a daemon
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Podman/Buildah
        id: podman-check
        run: |
          if command -v podman &> /dev/null; then
            podman --version
            echo "podman_available=true" >> $GITHUB_OUTPUT
          elif command -v buildah &> /dev/null; then
            buildah --version
            echo "podman_available=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Podman/Buildah not available"
            echo "podman_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Container Registry
        if: steps.podman-check.outputs.podman_available == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Build and push with Podman
        if: steps.podman-check.outputs.podman_available == 'true'
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          podman build \
            --file Dockerfile.pcscf \
            --tag "$IMAGE_TAG" \
            --tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
            .
          
          podman push "$IMAGE_TAG"
          podman push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
