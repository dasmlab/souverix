name: Status Update

on:
  workflow_run:
    workflows: ["Build", "Test", "Lint"]
    types:
      - completed
  push:
    branches: [main]
  schedule:
    - cron: '*/15 * * * *' # Every 15 minutes
  workflow_dispatch:

jobs:
  update-status:
    runs-on: self-hosted
    permissions:
      contents: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get workflow statuses
      id: status
      uses: actions/github-script@v7
      with:
        script: |
          const workflows = [
            { name: 'build', file: 'build.yml' },
            { name: 'test', file: 'test.yml' },
            { name: 'lint', file: 'lint.yml' }
          ];
          const statuses = {};
          
          for (const workflow of workflows) {
            try {
              // Try using the workflow file name (case-sensitive)
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.file,
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                statuses[workflow.name] = {
                  status: run.status === 'completed' ? run.conclusion : run.status,
                  sha: run.head_sha.substring(0, 7),
                  time: run.updated_at,
                  url: run.html_url
                };
              } else {
                statuses[workflow.name] = {
                  status: 'unknown',
                  sha: 'N/A',
                  time: null,
                  url: null
                };
              }
            } catch (error) {
              // If workflow not found, mark as unknown
              console.log(`Workflow ${workflow.file} not found or error: ${error.message}`);
              statuses[workflow.name] = {
                status: 'unknown',
                sha: 'N/A',
                time: null,
                url: null
              };
            }
          }
          
          core.setOutput('statuses', JSON.stringify(statuses));
          return statuses;

    - name: Generate status badge
      id: badge
      run: |
        STATUSES='${{ steps.status.outputs.statuses }}'
        echo "STATUSES=$STATUSES" >> $GITHUB_ENV
        
        # Generate badge URLs
        BUILD_STATUS=$(echo $STATUSES | jq -r '.build.status // "unknown"')
        TEST_STATUS=$(echo $STATUSES | jq -r '.test.status // "unknown"')
        LINT_STATUS=$(echo $STATUSES | jq -r '.lint.status // "unknown"')
        
        # Convert to badge format
        if [ "$BUILD_STATUS" = "success" ]; then
          BUILD_BADGE="https://img.shields.io/badge/build-passing-brightgreen"
        elif [ "$BUILD_STATUS" = "failure" ]; then
          BUILD_BADGE="https://img.shields.io/badge/build-failing-red"
        else
          BUILD_BADGE="https://img.shields.io/badge/build-unknown-lightgrey"
        fi
        
        if [ "$TEST_STATUS" = "success" ]; then
          TEST_BADGE="https://img.shields.io/badge/tests-passing-brightgreen"
        elif [ "$TEST_STATUS" = "failure" ]; then
          TEST_BADGE="https://img.shields.io/badge/tests-failing-red"
        else
          TEST_BADGE="https://img.shields.io/badge/tests-unknown-lightgrey"
        fi
        
        if [ "$LINT_STATUS" = "success" ]; then
          LINT_BADGE="https://img.shields.io/badge/lint-passing-brightgreen"
        elif [ "$LINT_STATUS" = "failure" ]; then
          LINT_BADGE="https://img.shields.io/badge/lint-failing-red"
        else
          LINT_BADGE="https://img.shields.io/badge/lint-unknown-lightgrey"
        fi
        
        echo "BUILD_BADGE=$BUILD_BADGE" >> $GITHUB_ENV
        echo "TEST_BADGE=$TEST_BADGE" >> $GITHUB_ENV
        echo "LINT_BADGE=$LINT_BADGE" >> $GITHUB_ENV

    - name: Update README with status
      run: |
        # This would update README.md with current status
        # For now, we'll create a status.json file
        cat > status.json << EOF
        {
          "build": ${{ steps.status.outputs.statuses }},
          "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
